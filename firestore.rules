rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check group membership
    function isGroupMember(groupId) {
      return get(/databases/$(database)/documents/groups/$(groupId)).data.members.hasAny([request.auth.uid]);
    }

    match /groups/{groupId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth.uid == resource.data.createdBy || isGroupMember(groupId);

      match /fr_pool/{albumId} {
        allow read, write: if isGroupMember(groupId);
      }

      match /inter_pool/{albumId} {
        allow read, write: if isGroupMember(groupId);
      }
      
      // Rules for user-specific rankings within a group
      match /rankings/{userId} {
        // A user can read any ranking in a group they belong to.
        allow read: if isGroupMember(groupId);
        // A user can only create or update their own ranking document.
        allow create, update: if request.auth.uid == userId && isGroupMember(groupId);
      }
    }
    
    // This rule allows the collectionGroup query for the Community View.
    // It ensures a user can READ rankings from groups they are a member of.
    match /{path=**}/rankings/{userId} {
        // Allow reading a ranking document if the requesting user is a member 
        // of the group specified in that document's `userInfo.groupId` field.
        allow read: if get(/databases/$(database)/documents/groups/$(resource.data.userInfo.groupId)).data.members.hasAny([request.auth.uid]);
    }
  }
}
